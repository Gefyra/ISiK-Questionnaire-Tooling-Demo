import"./main-BNE15Agw.js";const f=e=>document.getElementById(e),S=()=>f("status"),a=(e,t)=>{const n=S();n&&(n.className=t||"",n.textContent=e||"")};let v;function d(...e){const t=new URLSearchParams(window.location.search);for(const n of e){const i=t.get(n);if(i!==null&&i!=="")return i}return null}function w(){const e=["base","prepopBase","pid","fid","qCanonical","patient","encounter","user","id","q","minimal"],t={};for(const n of e){const i=f(n);i&&i.value.trim()!==""&&(t[n]=i.value.trim())}return t}function B(e){const t=["base","prepopBase","pid","fid","qCanonical","patient","encounter","user","id","q"];for(const n of t)f(n)&&e[n]!==void 0&&e[n]!==null&&(f(n).value=String(e[n]))}function P(){const e={base:d("base"),prepopBase:d("prepopBase"),pid:d("pid"),fid:d("fid"),qCanonical:d("qCanonical","canonical"),patient:d("patient"),encounter:d("encounter"),user:d("user"),id:d("id"),q:d("q","questionnaire"),minimal:(d("minimal")||"").toLowerCase()==="true"?"true":void 0};return v=e.minimal,B(e),e}function y(e,t){if(!t)return e;if(/^https?:/i.test(t))return t;const n=(e||"").replace(/\/?$/,""),i=String(t).replace(/^\//,"");return`${n}/${i}`}function A(){const e=w();return v==="true"&&(e.minimal="true"),e}function E(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%2F/gi,"/").replace(/%7C/gi,"|")}function C(){const e=window.location.origin+window.location.pathname,t=A(),n=[];for(const[s,p]of Object.entries(t))p!=null&&String(p)!==""&&n.push(`${s}=${E(String(p))}`);const i=n.join("&"),c=i?`${e}?${i}`:e,l=f("shareUrl");l&&(l.value=c)}async function $(e){const t=await fetch(e,{headers:{Accept:"application/fhir+json"}});if(!t.ok)throw new Error(`HTTP ${t.status} for ${e}`);return t.json()}function I(e){return!e||e.resourceType!=="Bundle"?[]:(e.entry||[]).map(t=>t&&(t.resource||t)).filter(Boolean)}function U(e){const n=(Array.isArray(e.name)?e.name.map(s=>[s.prefix,s.given,s.family].flat().filter(Boolean).join(" ")).filter(Boolean):[])[0]||"(ohne Name)",i=Array.isArray(e.identifier)?e.identifier.map(s=>`${s.system||""}|${s.value||""}`).join(", "):"",c=e.birthDate?`, geb. ${e.birthDate}`:"",l=e.gender?`, ${e.gender}`:"";return`${n}${c}${l}${i?` — ${i}`:""}`}function j(e){const t=e.name||e.description||"(Account)",n=e.status?`, Status: ${e.status}`:"",i=Array.isArray(e.identifier)?e.identifier.map(c=>`${c.system||""}|${c.value||""}`).join(", "):"";return`${t}${n}${i?` — ${i}`:""}`}function x(e){const t=e.title||e.name||e.id||"(Questionnaire)",n=e.version?` v${e.version}`:"",i=e.url?` — ${e.url}`:"";return`${t}${n}${i}`}function b(e,t,n,i,c){const l=f(e);if(!l||(l.replaceChildren(),!n||n.length===0))return;const s=document.createElement("div");s.className="result-title",s.textContent=`${t} – mehrere Treffer, bitte wählen:`,l.appendChild(s),n.forEach(p=>{const h=document.createElement("div");h.className="result-card";const o=document.createElement("div");o.textContent=c(p);const r=document.createElement("div");r.style.marginTop="6px";const u=document.createElement("button");u.className="btn secondary",u.textContent="Auswählen",u.onclick=()=>i(p),r.appendChild(u),h.appendChild(o),h.appendChild(r),l.appendChild(h)})}function F(){["patientResults","accountResults","questionnaireResults"].forEach(e=>{const t=f(e);t&&t.replaceChildren()})}function Q(e){const t=new URL("index.html",window.location.href),n=new URLSearchParams;return e.q&&n.set("q",e.q),e.base&&n.set("base",e.base),e.id&&n.set("id",e.id),e.prepopBase&&n.set("prepopBase",e.prepopBase),e.patient&&n.set("patient",e.patient),e.encounter&&n.set("encounter",e.encounter),e.user&&n.set("user",e.user),e.account&&n.set("account",e.account),e.minimal==="true"&&n.set("minimal","true"),t.search=n.toString(),t.toString()}async function k(e){F();const t=e.base;if(!t){a("Bitte FHIR Base angeben.","err");return}a("Suche wird ausgeführt …");const n={...e},i=!n.q&&!n.id&&!!n.qCanonical,c=!n.patient&&!!n.pid,l=!!n.fid,s=[];if(c){const o=y(t,`Patient?identifier=${encodeURIComponent(n.pid)}`);s.push($(o).then(r=>({key:"patient",bundle:r})).catch(r=>({key:"patient",error:r})))}if(l){const o=y(t,`Account?identifier=${encodeURIComponent(n.fid)}`);s.push($(o).then(r=>({key:"account",bundle:r})).catch(r=>({key:"account",error:r})))}if(i){let o=n.qCanonical,r=null;if(o.includes("|")){const[m,R]=o.split("|");o=m,r=R}const u=r?`Questionnaire?url=${encodeURIComponent(o)}&version=${encodeURIComponent(r)}`:`Questionnaire?url=${encodeURIComponent(o)}`,q=y(t,u);s.push($(q).then(m=>({key:"questionnaire",bundle:m})).catch(m=>({key:"questionnaire",error:m})))}const p=await Promise.all(s);let h=!1;for(const o of p){if(o.error){a(`Fehler bei ${o.key}-Suche: ${o.error.message}`,"err");return}const r=I(o.bundle);if(o.key==="patient"){if(r.length===0){a("Kein Patient für pid gefunden.","err");return}r.length===1?n.patient=r[0].id:(h=!0,b("patientResults","Patient",r,u=>{n.patient=u.id,g(n)},U))}if(o.key==="account"){if(r.length===0){a("Kein Account für fid gefunden.","err");return}r.length===1?n.account=r[0].id:(h=!0,b("accountResults","Account",r,u=>{n.account=u.id,g(n)},j))}if(o.key==="questionnaire"){if(r.length===0){a("Kein Questionnaire für qCanonical gefunden.","err");return}r.length===1?n.id=r[0].id:(h=!0,b("questionnaireResults","Questionnaire",r,u=>{n.id=u.id,g(n)},x))}}h?a("Bitte eine Auswahl treffen, dann wird weitergeleitet …","ok"):g(n)}function g(e){const t=[];if(e.pid&&!e.patient&&t.push("patient"),e.fid&&!e.account&&t.push("account"),e.qCanonical&&!e.q&&!e.id&&t.push("questionnaire"),t.length>0)return;if(e.id&&e.base)e.q=void 0;else if(!(!e.id&&e.q)){if(e.id&&!e.base){a("Questionnaire-ID vorhanden, aber kein base-Parameter. Bitte base setzen.","err");return}}const n=Q(e);a("Weiterleitung zur Formular-Seite …","ok"),window.location.assign(n)}(function(){const t=P();C(),["base","prepopBase","pid","fid","qCanonical","patient","encounter","user","id","q"].forEach(i=>{const c=f(i);c&&c.addEventListener("input",C)});const n=f("btnCopyUrl");n&&(n.onclick=async()=>{try{const i=f("shareUrl")?.value||"";if(!i)return a("Kein Link vorhanden.","err");await navigator.clipboard.writeText(i),a("Link kopiert.","ok")}catch{a("Kopieren fehlgeschlagen.","err")}}),f("btnRun").onclick=async()=>{try{const i={...t,...w()};Object.keys(i).forEach(c=>{i[c]===""&&delete i[c]}),await k(i)}catch(i){a(i.message,"err")}},t.base&&(t.pid||t.fid||t.qCanonical)?k(t):a("Parameter prüfen und ggf. „Suchen“ klicken …")})();
