import"./main-3C7Y8jW-.js";/* empty css                */const g=e=>document.getElementById(e),U=()=>g("status"),c=(e,n)=>{const i=U();i&&(i.className=n||"",i.textContent=e||"")};let I,k;function h(...e){const n=new URLSearchParams(window.location.search);for(const i of e){const t=n.get(i);if(t!==null&&t!=="")return t}return null}function L(){const e=["base","prepopBase","pid","fid","qCanonical","patient","encounter","user","id","q","minimal"],n={};for(const i of e){const t=g(i);t&&t.value.trim()!==""&&(n[i]=t.value.trim())}return n}function _(e){const n=["base","prepopBase","pid","fid","qCanonical","patient","encounter","user","id","q"];for(const i of n)g(i)&&e[i]!==void 0&&e[i]!==null&&(g(i).value=String(e[i]))}function x(){const e={base:h("base"),prepopBase:h("prepopBase"),pid:h("pid"),fid:h("fid"),qCanonical:h("qCanonical","canonical"),patient:h("patient"),encounter:h("encounter"),user:h("user"),id:h("id"),q:h("q","questionnaire"),minimal:(h("minimal")||"").toLowerCase()==="true"?"true":void 0};return I=e.minimal,k=h("browse"),_(e),e}function $(e,n){if(!n)return e;if(/^https?:/i.test(n))return n;const i=(e||"").replace(/\/?$/,""),t=String(n).replace(/^\//,"");return`${i}/${t}`}function D(){const e=L();return I==="true"&&(e.minimal="true"),k&&(e.browse=k),e}function j(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%2F/gi,"/").replace(/%7C/gi,"|")}function B(){const e=window.location.origin+window.location.pathname,n=D(),i=[];for(const[m,b]of Object.entries(n))b!=null&&String(b)!==""&&i.push(`${m}=${j(String(b))}`);const t=i.join("&"),a=t?`${e}?${t}`:e,d=g("shareUrl");d&&(d.value=a)}async function R(e){const n=await fetch(e,{headers:{Accept:"application/fhir+json"}});if(!n.ok)throw new Error(`HTTP ${n.status} for ${e}`);return n.json()}function Q(e){return!e||e.resourceType!=="Bundle"?[]:(e.entry||[]).map(n=>n&&(n.resource||n)).filter(Boolean)}function F(e){return(Array.isArray(e.name)?e.name.map(i=>[i.prefix,i.given,i.family].flat().filter(Boolean).join(" ")).filter(Boolean):[])[0]||"(ohne Name)"}function T(e){const n=[];e.id&&n.push(["ID",e.id]),e.birthDate&&n.push(["Geburtsdatum",e.birthDate]),e.gender&&n.push(["Geschlecht",e.gender]);const i=Array.isArray(e.identifier)?e.identifier.map(t=>`${t.system||""}|${t.value||""}`).filter(Boolean):[];return i.length&&n.push(["Identifier",i.join(", ")]),n}function N(e){return e.name||e.description||"(Account)"}function H(e){const n=[];e.id&&n.push(["ID",e.id]),e.status&&n.push(["Status",e.status]);const i=Array.isArray(e.identifier)?e.identifier.map(t=>`${t.system||""}|${t.value||""}`).filter(Boolean):[];return i.length&&n.push(["Identifier",i.join(", ")]),n}function K(e){return e.title||e.name||e.id||"(Questionnaire)"}function G(e){const n=[];return e.id&&n.push(["ID",e.id]),e.version&&n.push(["Version",e.version]),e.url&&n.push(["URL",e.url]),e.description&&n.push(["Beschreibung",{html:V(String(e.description)),markdown:!0,block:!0}]),n}function q(e,n,i,t,a){const d=g(e);if(!d||(d.replaceChildren(),!i||i.length===0))return;const m=document.createElement("div");m.className="result-title",m.textContent=`${n} – mehrere Treffer, bitte wählen:`,d.appendChild(m);const b=p=>a==="Patient"?[F(p),T(p)]:a==="Account"?[N(p),H(p)]:[K(p),G(p)];i.forEach(p=>{const[y,v]=b(p),l=document.createElement("div");l.className="pick-panel",l.setAttribute("role","button"),l.setAttribute("tabindex","0");const o=document.createElement("h3");o.textContent=y;const r=document.createElement("div");r.className="inner";const s=document.createElement("div");s.className="kv",v.forEach(([u,f])=>{const A=f&&typeof f=="object"&&f.block,P=document.createElement("div");P.className="k"+(A?" block":""),P.textContent=u;const w=document.createElement("div");w.className="v"+(A?" block":""),f&&typeof f=="object"&&f.html?(w.classList.add("markdown"),f.markdown&&w.classList.add("desc"),w.innerHTML=f.html):w.textContent=String(f??""),s.appendChild(P),s.appendChild(w)}),r.appendChild(s),l.appendChild(o),l.appendChild(r),l.onclick=()=>t(p),l.onkeydown=u=>{(u.key==="Enter"||u.key===" ")&&(u.preventDefault(),t(p))},d.appendChild(l)})}function W(){["patientResults","accountResults","questionnaireResults"].forEach(e=>{const n=g(e);n&&n.replaceChildren()})}function z(e){const n=new URL("index.html",window.location.href),i=new URLSearchParams;return e.q&&i.set("q",e.q),e.base&&i.set("base",e.base),e.id&&i.set("id",e.id),e.prepopBase&&i.set("prepopBase",e.prepopBase),e.patient&&i.set("patient",e.patient),e.encounter&&i.set("encounter",e.encounter),e.user&&i.set("user",e.user),e.account&&i.set("account",e.account),e.minimal==="true"&&i.set("minimal","true"),n.search=i.toString(),n.toString()}async function S(e){W();const n=e.base,i=e.prepopBase||e.base;if(!n&&!i){c("Bitte FHIR Base angeben.","err");return}c("Suche wird ausgeführt …");const t={...e},a=!t.q&&!t.id&&!!t.qCanonical,d=!t.patient&&!!t.pid,m=!!t.fid,b=k&&String(k).toLowerCase().startsWith("q")||!a&&!d&&!m&&k&&String(k).toLowerCase()!=="patient",p=k&&String(k).toLowerCase().startsWith("p"),y=[];if(d){const o=$(n,`Patient?identifier=${encodeURIComponent(t.pid)}`);y.push(R(o).then(r=>({key:"patient",bundle:r})).catch(r=>({key:"patient",error:r})))}if(m){const o=$(n,`Account?identifier=${encodeURIComponent(t.fid)}`);y.push(R(o).then(r=>({key:"account",bundle:r})).catch(r=>({key:"account",error:r})))}if(a){let o=t.qCanonical,r=null;if(o.includes("|")){const[f,A]=o.split("|");o=f,r=A}const s=r?`Questionnaire?url=${encodeURIComponent(o)}&version=${encodeURIComponent(r)}`:`Questionnaire?url=${encodeURIComponent(o)}`,u=$(n,s);y.push(R(u).then(f=>({key:"questionnaire",bundle:f})).catch(f=>({key:"questionnaire",error:f})))}if(b){const r=$(n,"Questionnaire?_count=100&_elements=id,title,name,version,description,url");y.push(E(r).then(s=>({key:"questionnaireAll",items:s})).catch(s=>({key:"questionnaireAll",error:s})))}if(p){const s=$(i||n,"Patient?_count=100&_elements=id,name,birthDate,gender,identifier");y.push(E(s).then(u=>({key:"patientAll",items:u})).catch(u=>({key:"patientAll",error:u})))}const v=await Promise.all(y);let l=!1;for(const o of v){if(o.error){c(`Fehler bei ${o.key}-Suche: ${o.error.message}`,"err");return}const r=Q(o.bundle);if(o.key==="patient"){if(r.length===0){c("Kein Patient für pid gefunden.","err");return}r.length===1?t.patient=r[0].id:(l=!0,q("patientResults","Patient",r,s=>{t.patient=s.id,C(t)},"Patient"))}if(o.key==="account"){if(r.length===0){c("Kein Account für fid gefunden.","err");return}r.length===1?t.account=r[0].id:(l=!0,q("accountResults","Account",r,s=>{t.account=s.id,C(t)},"Account"))}if(o.key==="questionnaire"){if(r.length===0){c("Kein Questionnaire für qCanonical gefunden.","err");return}r.length===1?t.id=r[0].id:(l=!0,q("questionnaireResults","Questionnaire",r,s=>{t.id=s.id,C(t)},"Questionnaire"))}if(o.key==="questionnaireAll"){if(o.error){c(`Fehler beim Laden aller Questionnaires: ${o.error.message}`,"err");return}const s=o.items||[];if(s.length===0){c("Keine Questionnaires gefunden.","err");return}l=!0,q("questionnaireResults","Questionnaires",s,u=>{t.id=u.id,C(t)},"Questionnaire")}if(o.key==="patientAll"){if(o.error){c(`Fehler beim Laden aller Patienten: ${o.error.message}`,"err");return}const s=o.items||[];if(s.length===0){c("Keine Patienten gefunden.","err");return}l=!0,q("patientResults","Patienten",s,u=>{t.patient=u.id,C(t)},"Patient")}}l?c("Bitte eine Auswahl treffen, dann wird weitergeleitet …","ok"):C(t)}function C(e){const n=[];if(e.pid&&!e.patient&&n.push("patient"),e.fid&&!e.account&&n.push("account"),e.qCanonical&&!e.q&&!e.id&&n.push("questionnaire"),n.length>0)return;if(e.id&&e.base)e.q=void 0;else if(!(!e.id&&e.q)){if(e.id&&!e.base){c("Questionnaire-ID vorhanden, aber kein base-Parameter. Bitte base setzen.","err");return}}const i=z(e);c("Weiterleitung zur Formular-Seite …","ok"),window.location.assign(i)}(function(){const n=x();B(),["base","prepopBase","pid","fid","qCanonical","patient","encounter","user","id","q"].forEach(t=>{const a=g(t);a&&a.addEventListener("input",B)});const i=g("btnCopyUrl");i&&(i.onclick=async()=>{try{const t=g("shareUrl")?.value||"";if(!t)return c("Kein Link vorhanden.","err");await navigator.clipboard.writeText(t),c("Link kopiert.","ok")}catch{c("Kopieren fehlgeschlagen.","err")}}),g("btnRun").onclick=async()=>{try{const t={...n,...L()};Object.keys(t).forEach(a=>{t[a]===""&&delete t[a]}),await S(t)}catch(t){c(t.message,"err")}},n.base&&(n.pid||n.fid||n.qCanonical||k)?S(n):c("Parameter prüfen und ggf. „Suchen“ klicken …")})();function M(e){return e.replace(/[&<>]/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;"})[n])}function V(e){if(!e)return"";let n=String(e).replace(/\r\n/g,`
`);return n=M(n),n=n.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(i,t,a)=>{try{return`<a href="${/^https?:/i.test(a)?a:"#"}" target="_blank" rel="noopener noreferrer">${t}</a>`}catch{return t}}),n=n.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/__([^_]+)__/g,"<strong>$1</strong>"),n=n.replace(new RegExp("(?<!\\*)\\*([^*]+)\\*(?!\\*)","g"),"<em>$1</em>").replace(new RegExp("(?<!_)_([^_]+)_(?!_)","g"),"<em>$1</em>"),n=n.replace(/`([^`]+)`/g,"<code>$1</code>"),n=n.replace(/^#{1,6}\s*(.+)$/gm,"<strong>$1</strong>"),n=n.replace(/\n/g,"<br>"),n}async function E(e,n=1e3){const i=[];let t=e,a=0;for(;t&&a<n;){const d=await R(t);i.push(...Q(d));const m=(d.link||[]).find(b=>b.relation==="next")?.url;t=m?$(new URL(e).origin,m):null,a+=1}return i}
